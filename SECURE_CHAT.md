# 安全聊天功能使用说明

本文档介绍如何使用安全聊天功能，该功能实现了消息加密和顺序性保证，确保聊天信息的安全性和完整性。

## 功能特点

1. **消息加密**：使用 AES-GCM 算法对消息进行端到端加密
2. **消息顺序性**：通过序列号确保消息按正确顺序处理
3. **会话密钥**：每个连接生成唯一的会话密钥
4. **跨房源通信**：支持不同房源用户之间的通信

## 使用方法

### 1. 访问安全聊天页面

打开浏览器，访问：
```
http://localhost:8080/secure-chat
```

### 2. 建立连接

1. 输入服务器地址：`ws://localhost:8080/ws/house`
2. 输入房源ID：例如 `101`
3. 输入用户ID：例如 `1001`
4. 点击"连接"按钮

连接成功后，服务器会返回一个会话密钥，用于加密通信。

### 3. 发送加密消息

1. 输入接收者ID：例如 `2001`
2. 输入消息内容
3. 确保"加密消息"选项已勾选
4. 点击"发送消息"按钮

### 4. 接收和解密消息

当收到加密消息时，系统会自动使用会话密钥解密消息，并显示解密后的内容。

## 技术实现

### 客户端加密流程

1. 生成密钥：使用 Web Crypto API 从会话密钥生成 AES-GCM 密钥
2. 加密消息：使用 AES-GCM 算法加密消息内容
3. 添加序列号：每条消息都有唯一的递增序列号
4. 发送消息：将加密后的消息和元数据发送给服务器

### 服务器处理流程

1. 接收消息：服务器接收加密消息
2. 验证序列号：确保消息按正确顺序处理
3. 转发消息：将加密消息转发给接收者
4. 不解密内容：服务器不解密消息内容，保证端到端加密

### 客户端解密流程

1. 接收消息：客户端接收加密消息
2. 验证序列号：检查消息序列号是否合理
3. 解密消息：使用会话密钥解密消息内容
4. 显示消息：显示解密后的消息内容

## 安全注意事项

1. 会话密钥仅在客户端和服务器之间传输一次，之后所有通信都使用派生的加密密钥
2. 服务器不存储或解密消息内容，只负责转发
3. 使用 HTTPS 可以进一步提高安全性
4. 定期更换会话密钥可以增强安全性

## 测试方法

### 1. 测试加密通信

1. 打开两个浏览器窗口，分别访问安全聊天页面
2. 在两个窗口中分别连接不同的用户
3. 互相发送加密消息
4. 验证消息能够正确加密和解密

### 2. 测试消息顺序性

1. 快速连续发送多条消息
2. 验证消息是否按正确顺序显示

### 3. 测试跨房源通信

1. 在两个窗口中连接不同房源的用户
2. 互相发送消息
3. 验证消息能够正确传递

## 常见问题

1. **无法连接 WebSocket**：检查服务器是否正常运行，URL 是否正确
2. **消息无法解密**：检查会话密钥是否正确，可能需要重新连接
3. **消息乱序**：网络延迟可能导致消息乱序，系统会尝试根据序列号排序

## 后续改进

1. 添加消息确认机制
2. 实现离线消息存储和推送
3. 支持群组加密通信
4. 添加消息撤回功能
5. 实现端到端加密的文件传输