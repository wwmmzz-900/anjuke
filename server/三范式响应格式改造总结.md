# 三范式响应格式改造总结

## 改造目标
将所有接口的响应修改为统一的三范式返回格式：`code`、`msg`、`data`

## 已完成的工作

### 1. 创建通用响应结构
- 创建了 `api/common/v1/common.proto` 文件
- 定义了统一的 `BaseResponse` 消息结构：
  ```protobuf
  message BaseResponse {
      int32 code = 1;    // 响应码：0表示成功，非0表示失败
      string msg = 2;    // 响应消息
      google.protobuf.Any data = 3;  // 响应数据
  }
  ```
- 定义了通用的分页信息结构 `PageInfo`

### 2. 修改Proto文件
已修改以下服务的proto文件，将所有RPC方法的返回类型改为 `api.common.v1.BaseResponse`：

#### 用户服务 (api/user/v2/user.proto)
- `CreateUser` → 返回 `BaseResponse`
- `RealName` → 返回 `BaseResponse`
- `UpdateUserStatus` → 返回 `BaseResponse`
- `SendSms` → 返回 `BaseResponse`
- `VerifySms` → 返回 `BaseResponse`

新增对应的数据结构：
- `CreateUserData`
- `RealNameData`
- `UpdateUserStatusData`
- `SendSmsData`
- `VerifySmsData`

#### 积分服务 (api/points/v5/points.proto)
- `GetUserPoints` → 返回 `BaseResponse`
- `GetPointsHistory` → 返回 `BaseResponse`
- `CheckIn` → 返回 `BaseResponse`
- `EarnPointsByConsume` → 返回 `BaseResponse`
- `UsePoints` → 返回 `BaseResponse`

新增对应的数据结构：
- `GetUserPointsData`
- `GetPointsHistoryData`
- `CheckInData`
- `EarnPointsByConsumeData`
- `UsePointsData`

#### 其他服务
- 交易服务 (api/transaction/v4/transaction.proto)
- 房屋服务 (api/house/v3/house.proto)
- 客户服务 (api/customer/v6/customer.proto)
- HelloWorld服务 (api/helloworld/v1/greeter.proto)

### 3. 修改服务层实现
已完成用户服务 (internal/service/user.go) 的改造：
- 添加了必要的import包
- 修改所有方法返回 `*commonv1.BaseResponse`
- 实现了统一的错误处理和成功响应格式
- 使用 `anypb.New()` 将具体数据封装到 `BaseResponse.Data` 中

创建了响应构建帮助函数 (internal/service/response.go)：
- `BuildSuccessResponse()` - 构建成功响应
- `BuildErrorResponse()` - 构建错误响应

## ✅ 已完成的所有工作

### 1. ✅ 完成积分服务实现改造
已修改 `internal/service/points.go`，所有方法现在返回 `*commonv1.BaseResponse` 格式：
- `GetUserPoints` - 查询用户积分余额
- `GetPointsHistory` - 查询积分明细记录（包含分页信息）
- `CheckIn` - 签到获取积分
- `EarnPointsByConsume` - 消费获取积分
- `UsePoints` - 使用积分抵扣

### 2. ✅ 其他服务实现改造
已完成所有服务实现文件的改造：
- ✅ 交易服务实现 (`internal/service/transaction.go`)
- ✅ 房屋服务实现 (`internal/service/house.go`)
- ✅ 客户服务实现 (`internal/service/customer.go`)
- ✅ HelloWorld服务实现 (`internal/service/greeter.go`)

### 3. ✅ 重新生成Proto代码
已成功执行 `make api` 命令，重新生成了所有proto相关的Go代码。

### 4. 待确认项目
- 依赖注入配置可能需要更新（如果有新的服务注册需求）

## 响应格式示例

### 成功响应
```json
{
  "code": 0,
  "msg": "操作成功",
  "data": {
    "user_id": "123",
    "name": "张三",
    "status": "verified"
  }
}
```

### 错误响应
```json
{
  "code": 1,
  "msg": "参数错误：缺少user_id",
  "data": null
}
```

### 分页响应
```json
{
  "code": 0,
  "msg": "查询成功",
  "data": {
    "records": [...],
    "page_info": {
      "page": 1,
      "page_size": 20,
      "total": 100,
      "total_pages": 5
    }
  }
}
```

## 注意事项

1. **向后兼容性**：这是一个破坏性变更，需要通知前端和其他调用方更新代码
2. **错误处理**：统一了错误响应格式，所有业务错误都通过code字段区分
3. **数据序列化**：使用了 `google.protobuf.Any` 类型来支持不同的数据结构
4. **分页信息**：统一了分页信息的格式，使用 `PageInfo` 结构

## 下一步行动

1. 完成积分服务的实现改造
2. 重新生成proto代码
3. 测试所有接口的响应格式
4. 更新API文档
5. 通知相关团队进行适配