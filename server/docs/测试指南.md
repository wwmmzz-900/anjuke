# 测试指南

## 概述

本项目采用分层测试策略，包含单元测试、集成测试和端到端测试。测试覆盖了以下层次：

- **Service层测试**: 测试业务逻辑和API接口
- **Biz层测试**: 测试用例逻辑和业务规则
- **Data层测试**: 测试数据访问和存储逻辑

## 测试结构

```
server/
├── internal/
│   ├── biz/
│   │   ├── user.go
│   │   └── user_test.go          # 业务逻辑测试
│   ├── data/
│   │   ├── user.go
│   │   ├── user_test.go          # 数据层测试
│   │   ├── minio.go
│   │   ├── minio_test.go         # MinIO集成测试
│   │   ├── minio_multipart.go
│   │   └── minio_multipart_test.go
│   ├── service/
│   │   ├── user.go
│   │   ├── user_test.go          # 服务层测试
│   │   ├── upload.go
│   │   └── upload_test.go
│   ├── mocks/
│   │   └── mocks.go              # 测试模拟对象
│   └── testutil/
│       └── testutil.go           # 测试工具函数
└── scripts/
    ├── run_tests.sh              # Linux/Mac测试脚本
    └── run_tests.bat             # Windows测试脚本
```

## 运行测试

### 使用脚本运行

**Linux/Mac:**
```bash
# 运行所有测试
./scripts/run_tests.sh

# 运行单元测试（跳过集成测试）
./scripts/run_tests.sh -u

# 运行集成测试
./scripts/run_tests.sh -i

# 生成覆盖率报告
./scripts/run_tests.sh -c

# 详细输出
./scripts/run_tests.sh -v
```

**Windows:**
```cmd
REM 运行所有测试
scripts\run_tests.bat

REM 运行单元测试
scripts\run_tests.bat -u

REM 生成覆盖率报告
scripts\run_tests.bat -c
```

### 使用Go命令直接运行

```bash
# 运行所有测试
go test ./internal/...

# 运行特定包的测试
go test ./internal/biz/
go test ./internal/data/
go test ./internal/service/

# 运行特定测试函数
go test -run TestUserUsecase_SendSms ./internal/biz/

# 生成覆盖率报告
go test -coverprofile=coverage.out ./internal/...
go tool cover -html=coverage.out -o coverage.html

# 详细输出
go test -v ./internal/...

# 运行基准测试
go test -bench=. ./internal/...
```

## 测试分类

### 单元测试

单元测试使用模拟对象（mocks）来隔离依赖，专注于测试单个函数或方法的逻辑。

**特点:**
- 快速执行
- 不依赖外部服务
- 使用 `mocks` 包中的模拟对象
- 可以并行运行

**示例:**
```go
func TestUserUsecase_SendSms(t *testing.T) {
    // 使用模拟对象
    mockUserRepo := &mocks.MockUserRepo{
        SmsRiskControlFunc: func(ctx context.Context, phone, deviceID, ip string) error {
            return nil
        },
    }
    
    uc := &UserUsecase{
        repo: mockUserRepo,
        // ...
    }
    
    // 测试逻辑
}
```

### 集成测试

集成测试需要真实的外部服务（如数据库、MinIO等）。

**特点:**
- 需要外部服务支持
- 执行较慢
- 测试真实的数据流
- 使用 `testutil` 包中的辅助函数

**示例:**
```go
func TestUserRepo_CreateUser(t *testing.T) {
    // 设置测试数据库
    db, cleanup := testutil.SetupTestDB(t)
    defer cleanup()
    
    repo := NewUserRepo(db, testutil.MockLogger())
    
    // 测试逻辑
}
```

## 测试工具

### Mock对象

`internal/mocks/mocks.go` 提供了所有接口的模拟实现：

- `MockUserRepo`: 用户仓储模拟
- `MockSmsRepo`: 短信服务模拟  
- `MockMinioRepo`: MinIO存储模拟

### 测试工具函数

`internal/testutil/testutil.go` 提供了测试辅助函数：

- `SetupTestDB()`: 设置测试数据库
- `SetupTestRedis()`: 设置测试Redis
- `MockLogger()`: 创建模拟日志器
- `CreateTestUser()`: 创建测试用户
- `AssertError()`: 错误断言
- `AssertEqual()`: 相等断言
- `AssertNotNil()`: 非空断言

## 测试配置

### 数据库配置

测试使用独立的测试数据库，配置在 `testutil.GetTestConfig()` 中：

```go
Database: &conf.Data_Database{
    Driver: "mysql",
    Source: "root:test@tcp(localhost:3306)/anjuke_test?parseTime=True&loc=Local",
}
```

### MinIO配置

MinIO集成测试需要本地MinIO服务：

```go
Minio: &MinioConfig{
    Endpoint:  "localhost:9000",
    AccessKey: "minioadmin", 
    SecretKey: "minioadmin",
    UseSsl:    false,
    Bucket:    "test-bucket",
}
```

## 测试最佳实践

### 1. 测试命名

- 测试函数名格式: `Test<StructName>_<MethodName>`
- 测试用例名格式: 描述性的中文名称

```go
func TestUserService_SendSms(t *testing.T) {
    tests := []struct {
        name        string
        // ...
    }{
        {
            name: "发送短信成功",
            // ...
        },
        {
            name: "手机号为空",
            // ...
        },
    }
}
```

### 2. 表驱动测试

使用表驱动测试来覆盖多种场景：

```go
tests := []struct {
    name        string
    input       InputType
    expected    ExpectedType
    expectError bool
}{
    // 测试用例
}

for _, tt := range tests {
    t.Run(tt.name, func(t *testing.T) {
        // 测试逻辑
    })
}
```

### 3. 测试隔离

- 每个测试用例应该独立
- 使用 `setup` 和 `cleanup` 函数
- 避免测试之间的数据污染

### 4. 错误处理测试

确保测试覆盖正常流程和异常流程：

```go
testutil.AssertError(t, err, tt.expectError, "操作描述")
if !tt.expectError {
    testutil.AssertNotNil(t, result, "结果检查")
}
```

### 5. 跳过集成测试

对于需要外部服务的测试，在服务不可用时跳过：

```go
func TestMinioIntegration(t *testing.T) {
    client, err := NewMinioClient(config, logger)
    if err != nil {
        t.Skipf("MinIO连接失败，跳过测试: %v", err)
    }
    // 测试逻辑
}
```

## 持续集成

在CI/CD流水线中：

1. **单元测试**: 每次提交都运行
2. **集成测试**: 在有外部服务的环境中运行
3. **覆盖率检查**: 确保代码覆盖率达到要求

```yaml
# GitHub Actions 示例
- name: Run Unit Tests
  run: go test -short ./internal/...

- name: Run Integration Tests  
  run: go test -run Integration ./internal/...
  
- name: Generate Coverage Report
  run: |
    go test -coverprofile=coverage.out ./internal/...
    go tool cover -html=coverage.out -o coverage.html
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查测试数据库是否启动
   - 确认连接字符串正确

2. **MinIO连接失败**
   - 检查MinIO服务是否运行在localhost:9000
   - 确认访问密钥正确

3. **测试超时**
   - 增加测试超时时间
   - 检查是否有死锁或无限循环

4. **并发测试失败**
   - 确保测试数据隔离
   - 使用不同的测试数据库/bucket

### 调试技巧

1. 使用 `-v` 参数查看详细输出
2. 使用 `-run` 参数运行特定测试
3. 在测试中添加日志输出
4. 使用调试器逐步执行

## 覆盖率目标

- **总体覆盖率**: ≥ 80%
- **核心业务逻辑**: ≥ 90%
- **数据访问层**: ≥ 85%
- **服务接口层**: ≥ 85%