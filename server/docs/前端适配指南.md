# å‰ç«¯é€‚é…æŒ‡å— - ä¸‰èŒƒå¼å“åº”æ ¼å¼

## ğŸ¯ é€‚é…æ¦‚è¿°

ç³»ç»ŸAPIå·²å…¨é¢å‡çº§ä¸ºç»Ÿä¸€çš„ä¸‰èŒƒå¼å“åº”æ ¼å¼ï¼š`{code, msg, data}`

**âš ï¸ é‡è¦æé†’**: è¿™æ˜¯ä¸€ä¸ªç ´åæ€§å˜æ›´ï¼Œéœ€è¦å‰ç«¯ä»£ç è¿›è¡Œç›¸åº”é€‚é…ã€‚

## ğŸ“‹ å˜æ›´å¯¹æ¯”

### æ–°æ ¼å¼ (æ”¹é€ å)
```javascript
// ç»Ÿä¸€çš„ä¸‰èŒƒå¼æ ¼å¼
// æˆåŠŸå“åº”
{
  "code": 0,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    // å…·ä½“ä¸šåŠ¡æ•°æ®
  }
}

// é”™è¯¯å“åº”
{
  "code": 1,
  "msg": "é”™è¯¯ä¿¡æ¯",
  "data": null
}

// åˆ†é¡µå“åº”
{
  "code": 0,
  "msg": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "records": [...],
    "page_info": {
      "page": 1,
      "page_size": 20,
      "total": 100,
      "total_pages": 5
    }
  }
}
```

## ğŸ”§ é€‚é…æ­¥éª¤

### 1. æ›´æ–°HTTPè¯·æ±‚å¤„ç†

#### æ—§ä»£ç 
```javascript
// æ—§çš„è¯·æ±‚å¤„ç†æ–¹å¼
async function getUserPoints(userId) {
  try {
    const response = await fetch(`/points/balance/${userId}`);
    const data = await response.json();
    
    // ç›´æ¥ä½¿ç”¨è¿”å›çš„æ•°æ®
    if (data.Msg === "æŸ¥è¯¢æˆåŠŸ") {
      return {
        userId: data.UserId,
        totalPoints: data.TotalPoints
      };
    } else {
      throw new Error(data.Msg);
    }
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
}
```

#### æ–°ä»£ç 
```javascript
// æ–°çš„è¯·æ±‚å¤„ç†æ–¹å¼
async function getUserPoints(userId) {
  try {
    const response = await fetch(`/points/balance/${userId}`);
    const result = await response.json();
    
    // ç»Ÿä¸€æ£€æŸ¥codeå­—æ®µ
    if (result.code === 0) {
      return result.data; // ä¸šåŠ¡æ•°æ®åœ¨dataå­—æ®µä¸­
    } else {
      throw new Error(result.msg);
    }
  } catch (error) {
    console.error('è¯·æ±‚å¤±è´¥:', error);
    throw error;
  }
}
```

### 2. åˆ›å»ºç»Ÿä¸€çš„è¯·æ±‚å°è£…

```javascript
// api-client.js - ç»Ÿä¸€çš„APIå®¢æˆ·ç«¯
class ApiClient {
  constructor(baseURL = '') {
    this.baseURL = baseURL;
  }

  async request(url, options = {}) {
    try {
      const response = await fetch(this.baseURL + url, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });

      const result = await response.json();

      // ç»Ÿä¸€å¤„ç†ä¸‰èŒƒå¼å“åº”
      if (result.code === 0) {
        return result.data;
      } else {
        throw new ApiError(result.code, result.msg);
      }
    } catch (error) {
      if (error instanceof ApiError) {
        throw error;
      }
      throw new ApiError(-1, 'ç½‘ç»œè¯·æ±‚å¤±è´¥');
    }
  }

  // GETè¯·æ±‚
  async get(url, params = {}) {
    const queryString = new URLSearchParams(params).toString();
    const fullUrl = queryString ? `${url}?${queryString}` : url;
    return this.request(fullUrl);
  }

  // POSTè¯·æ±‚
  async post(url, data = {}) {
    return this.request(url, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  // PUTè¯·æ±‚
  async put(url, data = {}) {
    return this.request(url, {
      method: 'PUT',
      body: JSON.stringify(data)
    });
  }

  // DELETEè¯·æ±‚
  async delete(url) {
    return this.request(url, {
      method: 'DELETE'
    });
  }
}

// è‡ªå®šä¹‰é”™è¯¯ç±»
class ApiError extends Error {
  constructor(code, message) {
    super(message);
    this.name = 'ApiError';
    this.code = code;
  }
}

// å¯¼å‡ºå®ä¾‹
export const apiClient = new ApiClient('/api');
export { ApiError };
```

### 3. æ›´æ–°ä¸šåŠ¡æ¥å£è°ƒç”¨

```javascript
// user-api.js - ç”¨æˆ·ç›¸å…³æ¥å£
import { apiClient } from './api-client.js';

export const userApi = {
  // åˆ›å»ºç”¨æˆ·
  async createUser(userData) {
    return await apiClient.post('/user/create', {
      Mobile: userData.mobile,
      NickName: userData.nickName,
      Password: userData.password
    });
  },

  // å®åè®¤è¯
  async realName(userId, name, idCard) {
    return await apiClient.post('/user/realname', {
      UserId: userId,
      Name: name,
      IdCard: idCard
    });
  },

  // å‘é€çŸ­ä¿¡
  async sendSms(phone, deviceId, scene) {
    return await apiClient.post('/user/sendSms', {
      phone,
      device_id: deviceId,
      scene
    });
  },

  // éªŒè¯çŸ­ä¿¡
  async verifySms(phone, code, scene) {
    return await apiClient.post('/user/verifySms', {
      phone,
      code,
      scene
    });
  }
};
```

```javascript
// points-api.js - ç§¯åˆ†ç›¸å…³æ¥å£
import { apiClient } from './api-client.js';

export const pointsApi = {
  // æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†
  async getUserPoints(userId) {
    return await apiClient.get(`/points/balance/${userId}`);
  },

  // æŸ¥è¯¢ç§¯åˆ†å†å²
  async getPointsHistory(userId, page = 1, pageSize = 20, type = '') {
    return await apiClient.get(`/points/history/${userId}`, {
      page,
      page_size: pageSize,
      type
    });
  },

  // ç­¾åˆ°
  async checkIn(userId) {
    return await apiClient.post('/points/checkin', {
      user_id: userId
    });
  },

  // æ¶ˆè´¹è·å–ç§¯åˆ†
  async earnPointsByConsume(userId, orderId, amount) {
    return await apiClient.post('/points/earn/consume', {
      user_id: userId,
      order_id: orderId,
      amount
    });
  },

  // ä½¿ç”¨ç§¯åˆ†
  async usePoints(userId, points, orderId, description) {
    return await apiClient.post('/points/use', {
      user_id: userId,
      points,
      order_id: orderId,
      description
    });
  }
};
```

### 4. æ›´æ–°Vue.jsç»„ä»¶ç¤ºä¾‹

```vue
<!-- UserPoints.vue -->
<template>
  <div class="user-points">
    <div v-if="loading">åŠ è½½ä¸­...</div>
    <div v-else-if="error" class="error">{{ error }}</div>
    <div v-else>
      <h3>æˆ‘çš„ç§¯åˆ†</h3>
      <p>å½“å‰ç§¯åˆ†: {{ userPoints?.total_points || 0 }}</p>
      <button @click="handleCheckIn" :disabled="checkingIn">
        {{ checkingIn ? 'ç­¾åˆ°ä¸­...' : 'æ¯æ—¥ç­¾åˆ°' }}
      </button>
    </div>
  </div>
</template>

<script>
import { pointsApi } from '@/api/points-api.js';

export default {
  name: 'UserPoints',
  props: {
    userId: {
      type: Number,
      required: true
    }
  },
  data() {
    return {
      userPoints: null,
      loading: false,
      error: null,
      checkingIn: false
    };
  },
  async mounted() {
    await this.loadUserPoints();
  },
  methods: {
    async loadUserPoints() {
      this.loading = true;
      this.error = null;
      
      try {
        // æ–°çš„APIè¿”å›æ ¼å¼ï¼šç›´æ¥è·å–dataéƒ¨åˆ†
        this.userPoints = await pointsApi.getUserPoints(this.userId);
      } catch (error) {
        this.error = error.message;
        console.error('åŠ è½½ç§¯åˆ†å¤±è´¥:', error);
      } finally {
        this.loading = false;
      }
    },

    async handleCheckIn() {
      this.checkingIn = true;
      
      try {
        const result = await pointsApi.checkIn(this.userId);
        
        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        this.userPoints.total_points = result.total_points;
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        this.$message.success(`ç­¾åˆ°æˆåŠŸï¼è·å¾—${result.points_earned}ç§¯åˆ†`);
      } catch (error) {
        this.$message.error(error.message);
        console.error('ç­¾åˆ°å¤±è´¥:', error);
      } finally {
        this.checkingIn = false;
      }
    }
  }
};
</script>
```

### 5. æ›´æ–°Reactç»„ä»¶ç¤ºä¾‹

```jsx
// UserPoints.jsx
import React, { useState, useEffect } from 'react';
import { pointsApi } from '../api/points-api.js';

const UserPoints = ({ userId }) => {
  const [userPoints, setUserPoints] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [checkingIn, setCheckingIn] = useState(false);

  useEffect(() => {
    loadUserPoints();
  }, [userId]);

  const loadUserPoints = async () => {
    setLoading(true);
    setError(null);
    
    try {
      // æ–°çš„APIè¿”å›æ ¼å¼ï¼šç›´æ¥è·å–dataéƒ¨åˆ†
      const data = await pointsApi.getUserPoints(userId);
      setUserPoints(data);
    } catch (error) {
      setError(error.message);
      console.error('åŠ è½½ç§¯åˆ†å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleCheckIn = async () => {
    setCheckingIn(true);
    
    try {
      const result = await pointsApi.checkIn(userId);
      
      // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
      setUserPoints(prev => ({
        ...prev,
        total_points: result.total_points
      }));
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      alert(`ç­¾åˆ°æˆåŠŸï¼è·å¾—${result.points_earned}ç§¯åˆ†`);
    } catch (error) {
      alert(error.message);
      console.error('ç­¾åˆ°å¤±è´¥:', error);
    } finally {
      setCheckingIn(false);
    }
  };

  if (loading) return <div>åŠ è½½ä¸­...</div>;
  if (error) return <div className="error">{error}</div>;

  return (
    <div className="user-points">
      <h3>æˆ‘çš„ç§¯åˆ†</h3>
      <p>å½“å‰ç§¯åˆ†: {userPoints?.total_points || 0}</p>
      <button onClick={handleCheckIn} disabled={checkingIn}>
        {checkingIn ? 'ç­¾åˆ°ä¸­...' : 'æ¯æ—¥ç­¾åˆ°'}
      </button>
    </div>
  );
};

export default UserPoints;
```

### 6. åˆ†é¡µæ•°æ®å¤„ç†

```javascript
// åˆ†é¡µæ•°æ®å¤„ç†ç¤ºä¾‹
async function loadPointsHistory(userId, page = 1) {
  try {
    const result = await pointsApi.getPointsHistory(userId, page, 20);
    
    // æ–°æ ¼å¼çš„åˆ†é¡µæ•°æ®ç»“æ„
    return {
      records: result.records,
      pagination: {
        current: result.page_info.page,
        pageSize: result.page_info.page_size,
        total: result.page_info.total,
        totalPages: result.page_info.total_pages
      }
    };
  } catch (error) {
    console.error('åŠ è½½ç§¯åˆ†å†å²å¤±è´¥:', error);
    throw error;
  }
}
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. ç±»å‹æ£€æŸ¥é—®é¢˜
```typescript
// TypeScriptç±»å‹å®šä¹‰
interface BaseResponse<T = any> {
  code: number;
  msg: string;
  data: T | null;
}

interface UserPointsData {
  user_id: number;
  total_points: number;
}

interface PageInfo {
  page: number;
  page_size: number;
  total: number;
  total_pages: number;
}

interface PointsHistoryData {
  records: PointsRecord[];
  page_info: PageInfo;
}
```

### 2. é”™è¯¯å¤„ç†ç»Ÿä¸€åŒ–
```javascript
// å…¨å±€é”™è¯¯å¤„ç†
window.addEventListener('unhandledrejection', (event) => {
  if (event.reason instanceof ApiError) {
    // æ ¹æ®é”™è¯¯ç è¿›è¡Œä¸åŒå¤„ç†
    switch (event.reason.code) {
      case 1001:
        // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login';
        break;
      case 1002:
        // ç§¯åˆ†ä¸è¶³
        showMessage('ç§¯åˆ†ä¸è¶³ï¼Œè¯·å…ˆè·å–ç§¯åˆ†');
        break;
      default:
        showMessage(event.reason.message);
    }
    event.preventDefault();
  }
});
```

### 3. ç¼“å­˜ç­–ç•¥è°ƒæ•´
```javascript
// æ›´æ–°ç¼“å­˜é”®å
const CACHE_KEYS = {
  USER_POINTS: (userId) => `user_points_${userId}`,
  POINTS_HISTORY: (userId, page) => `points_history_${userId}_${page}`
};

// ç¼“å­˜é€‚é…
function setCacheData(key, data) {
  // åªç¼“å­˜dataéƒ¨åˆ†ï¼Œä¸ç¼“å­˜æ•´ä¸ªå“åº”
  localStorage.setItem(key, JSON.stringify(data));
}
```

## âœ… é€‚é…æ£€æŸ¥æ¸…å•

- [ ] æ›´æ–°æ‰€æœ‰APIè°ƒç”¨ï¼Œæ£€æŸ¥`result.code`è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨è¿”å›æ•°æ®
- [ ] ä»`result.data`ä¸­è·å–ä¸šåŠ¡æ•°æ®
- [ ] æ›´æ–°é”™è¯¯å¤„ç†é€»è¾‘ï¼Œä½¿ç”¨`result.msg`æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- [ ] æ›´æ–°åˆ†é¡µæ•°æ®å¤„ç†ï¼Œä½¿ç”¨`data.page_info`ç»“æ„
- [ ] æ›´æ–°TypeScriptç±»å‹å®šä¹‰ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
- [ ] æ›´æ–°å•å…ƒæµ‹è¯•ä¸­çš„mockæ•°æ®æ ¼å¼
- [ ] æ›´æ–°æ–‡æ¡£å’Œæ³¨é‡Š
- [ ] æµ‹è¯•æ‰€æœ‰ç›¸å…³åŠŸèƒ½

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **å•å…ƒæµ‹è¯•æ›´æ–°**: æ›´æ–°mockæ•°æ®ä¸ºæ–°çš„ä¸‰èŒƒå¼æ ¼å¼
2. **é›†æˆæµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„è¯·æ±‚-å“åº”æµç¨‹
3. **é”™è¯¯åœºæ™¯æµ‹è¯•**: æµ‹è¯•å„ç§é”™è¯¯ç çš„å¤„ç†
4. **è¾¹ç•Œæµ‹è¯•**: æµ‹è¯•ç©ºæ•°æ®ã€åˆ†é¡µè¾¹ç•Œç­‰æƒ…å†µ

## ğŸ“ æ”¯æŒå’Œåé¦ˆ

å¦‚åœ¨é€‚é…è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
2. è”ç³»åç«¯å¼€å‘å›¢é˜Ÿç¡®è®¤æ¥å£è¡Œä¸º
3. åœ¨å›¢é˜Ÿç¾¤ä¸­åé¦ˆé—®é¢˜

---
**é€‚é…æŒ‡å—ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2024å¹´1æœˆ  
**é€‚ç”¨èŒƒå›´**: ä¸‰èŒƒå¼å“åº”æ ¼å¼æ”¹é€ 