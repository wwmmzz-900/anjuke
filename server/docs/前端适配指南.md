# 前端适配指南 - 三范式响应格式

## 🎯 适配概述

系统API已全面升级为统一的三范式响应格式：`{code, msg, data}`

**⚠️ 重要提醒**: 这是一个破坏性变更，需要前端代码进行相应适配。

## 📋 变更对比

### 新格式 (改造后)
```javascript
// 统一的三范式格式
// 成功响应
{
  "code": 0,
  "msg": "操作成功",
  "data": {
    // 具体业务数据
  }
}

// 错误响应
{
  "code": 1,
  "msg": "错误信息",
  "data": null
}

// 分页响应
{
  "code": 0,
  "msg": "查询成功",
  "data": {
    "records": [...],
    "page_info": {
      "page": 1,
      "page_size": 20,
      "total": 100,
      "total_pages": 5
    }
  }
}
```

## 🔧 适配步骤

### 1. 更新HTTP请求处理

#### 旧代码
```javascript
// 旧的请求处理方式
async function getUserPoints(userId) {
  try {
    const response = await fetch(`/points/balance/${userId}`);
    const data = await response.json();
    
    // 直接使用返回的数据
    if (data.Msg === "查询成功") {
      return {
        userId: data.UserId,
        totalPoints: data.TotalPoints
      };
    } else {
      throw new Error(data.Msg);
    }
  } catch (error) {
    console.error('请求失败:', error);
    throw error;
  }
}
```

#### 新代码
```javascript
// 新的请求处理方式
async function getUserPoints(userId) {
  try {
    const response = await fetch(`/points/balance/${userId}`);
    const result = await response.json();
    
    // 统一检查code字段
    if (result.code === 0) {
      return result.data; // 业务数据在data字段中
    } else {
      throw new Error(result.msg);
    }
  } catch (error) {
    console.error('请求失败:', error);
    throw error;
  }
}
```

### 2. 创建统一的请求封装

```javascript
// api-client.js - 统一的API客户端
class ApiClient {
  constructor(baseURL = '') {
    this.baseURL = baseURL;
  }

  async request(url, options = {}) {
    try {
      const response = await fetch(this.baseURL + url, {
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        },
        ...options
      });

      const result = await response.json();

      // 统一处理三范式响应
      if (result.code === 0) {
        return result.data;
      } else {
        throw new ApiError(result.code, result.msg);
      }
    } catch (error) {
      if (error instanceof ApiError) {
        throw error;
      }
      throw new ApiError(-1, '网络请求失败');
    }
  }

  // GET请求
  async get(url, params = {}) {
    const queryString = new URLSearchParams(params).toString();
    const fullUrl = queryString ? `${url}?${queryString}` : url;
    return this.request(fullUrl);
  }

  // POST请求
  async post(url, data = {}) {
    return this.request(url, {
      method: 'POST',
      body: JSON.stringify(data)
    });
  }

  // PUT请求
  async put(url, data = {}) {
    return this.request(url, {
      method: 'PUT',
      body: JSON.stringify(data)
    });
  }

  // DELETE请求
  async delete(url) {
    return this.request(url, {
      method: 'DELETE'
    });
  }
}

// 自定义错误类
class ApiError extends Error {
  constructor(code, message) {
    super(message);
    this.name = 'ApiError';
    this.code = code;
  }
}

// 导出实例
export const apiClient = new ApiClient('/api');
export { ApiError };
```

### 3. 更新业务接口调用

```javascript
// user-api.js - 用户相关接口
import { apiClient } from './api-client.js';

export const userApi = {
  // 创建用户
  async createUser(userData) {
    return await apiClient.post('/user/create', {
      Mobile: userData.mobile,
      NickName: userData.nickName,
      Password: userData.password
    });
  },

  // 实名认证
  async realName(userId, name, idCard) {
    return await apiClient.post('/user/realname', {
      UserId: userId,
      Name: name,
      IdCard: idCard
    });
  },

  // 发送短信
  async sendSms(phone, deviceId, scene) {
    return await apiClient.post('/user/sendSms', {
      phone,
      device_id: deviceId,
      scene
    });
  },

  // 验证短信
  async verifySms(phone, code, scene) {
    return await apiClient.post('/user/verifySms', {
      phone,
      code,
      scene
    });
  }
};
```

```javascript
// points-api.js - 积分相关接口
import { apiClient } from './api-client.js';

export const pointsApi = {
  // 查询用户积分
  async getUserPoints(userId) {
    return await apiClient.get(`/points/balance/${userId}`);
  },

  // 查询积分历史
  async getPointsHistory(userId, page = 1, pageSize = 20, type = '') {
    return await apiClient.get(`/points/history/${userId}`, {
      page,
      page_size: pageSize,
      type
    });
  },

  // 签到
  async checkIn(userId) {
    return await apiClient.post('/points/checkin', {
      user_id: userId
    });
  },

  // 消费获取积分
  async earnPointsByConsume(userId, orderId, amount) {
    return await apiClient.post('/points/earn/consume', {
      user_id: userId,
      order_id: orderId,
      amount
    });
  },

  // 使用积分
  async usePoints(userId, points, orderId, description) {
    return await apiClient.post('/points/use', {
      user_id: userId,
      points,
      order_id: orderId,
      description
    });
  }
};
```

### 4. 更新Vue.js组件示例

```vue
<!-- UserPoints.vue -->
<template>
  <div class="user-points">
    <div v-if="loading">加载中...</div>
    <div v-else-if="error" class="error">{{ error }}</div>
    <div v-else>
      <h3>我的积分</h3>
      <p>当前积分: {{ userPoints?.total_points || 0 }}</p>
      <button @click="handleCheckIn" :disabled="checkingIn">
        {{ checkingIn ? '签到中...' : '每日签到' }}
      </button>
    </div>
  </div>
</template>

<script>
import { pointsApi } from '@/api/points-api.js';

export default {
  name: 'UserPoints',
  props: {
    userId: {
      type: Number,
      required: true
    }
  },
  data() {
    return {
      userPoints: null,
      loading: false,
      error: null,
      checkingIn: false
    };
  },
  async mounted() {
    await this.loadUserPoints();
  },
  methods: {
    async loadUserPoints() {
      this.loading = true;
      this.error = null;
      
      try {
        // 新的API返回格式：直接获取data部分
        this.userPoints = await pointsApi.getUserPoints(this.userId);
      } catch (error) {
        this.error = error.message;
        console.error('加载积分失败:', error);
      } finally {
        this.loading = false;
      }
    },

    async handleCheckIn() {
      this.checkingIn = true;
      
      try {
        const result = await pointsApi.checkIn(this.userId);
        
        // 更新积分显示
        this.userPoints.total_points = result.total_points;
        
        // 显示成功消息
        this.$message.success(`签到成功！获得${result.points_earned}积分`);
      } catch (error) {
        this.$message.error(error.message);
        console.error('签到失败:', error);
      } finally {
        this.checkingIn = false;
      }
    }
  }
};
</script>
```

### 5. 更新React组件示例

```jsx
// UserPoints.jsx
import React, { useState, useEffect } from 'react';
import { pointsApi } from '../api/points-api.js';

const UserPoints = ({ userId }) => {
  const [userPoints, setUserPoints] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [checkingIn, setCheckingIn] = useState(false);

  useEffect(() => {
    loadUserPoints();
  }, [userId]);

  const loadUserPoints = async () => {
    setLoading(true);
    setError(null);
    
    try {
      // 新的API返回格式：直接获取data部分
      const data = await pointsApi.getUserPoints(userId);
      setUserPoints(data);
    } catch (error) {
      setError(error.message);
      console.error('加载积分失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleCheckIn = async () => {
    setCheckingIn(true);
    
    try {
      const result = await pointsApi.checkIn(userId);
      
      // 更新积分显示
      setUserPoints(prev => ({
        ...prev,
        total_points: result.total_points
      }));
      
      // 显示成功消息
      alert(`签到成功！获得${result.points_earned}积分`);
    } catch (error) {
      alert(error.message);
      console.error('签到失败:', error);
    } finally {
      setCheckingIn(false);
    }
  };

  if (loading) return <div>加载中...</div>;
  if (error) return <div className="error">{error}</div>;

  return (
    <div className="user-points">
      <h3>我的积分</h3>
      <p>当前积分: {userPoints?.total_points || 0}</p>
      <button onClick={handleCheckIn} disabled={checkingIn}>
        {checkingIn ? '签到中...' : '每日签到'}
      </button>
    </div>
  );
};

export default UserPoints;
```

### 6. 分页数据处理

```javascript
// 分页数据处理示例
async function loadPointsHistory(userId, page = 1) {
  try {
    const result = await pointsApi.getPointsHistory(userId, page, 20);
    
    // 新格式的分页数据结构
    return {
      records: result.records,
      pagination: {
        current: result.page_info.page,
        pageSize: result.page_info.page_size,
        total: result.page_info.total,
        totalPages: result.page_info.total_pages
      }
    };
  } catch (error) {
    console.error('加载积分历史失败:', error);
    throw error;
  }
}
```

## 🚨 常见问题和解决方案

### 1. 类型检查问题
```typescript
// TypeScript类型定义
interface BaseResponse<T = any> {
  code: number;
  msg: string;
  data: T | null;
}

interface UserPointsData {
  user_id: number;
  total_points: number;
}

interface PageInfo {
  page: number;
  page_size: number;
  total: number;
  total_pages: number;
}

interface PointsHistoryData {
  records: PointsRecord[];
  page_info: PageInfo;
}
```

### 2. 错误处理统一化
```javascript
// 全局错误处理
window.addEventListener('unhandledrejection', (event) => {
  if (event.reason instanceof ApiError) {
    // 根据错误码进行不同处理
    switch (event.reason.code) {
      case 1001:
        // 用户不存在，跳转到登录页
        window.location.href = '/login';
        break;
      case 1002:
        // 积分不足
        showMessage('积分不足，请先获取积分');
        break;
      default:
        showMessage(event.reason.message);
    }
    event.preventDefault();
  }
});
```

### 3. 缓存策略调整
```javascript
// 更新缓存键名
const CACHE_KEYS = {
  USER_POINTS: (userId) => `user_points_${userId}`,
  POINTS_HISTORY: (userId, page) => `points_history_${userId}_${page}`
};

// 缓存适配
function setCacheData(key, data) {
  // 只缓存data部分，不缓存整个响应
  localStorage.setItem(key, JSON.stringify(data));
}
```

## ✅ 适配检查清单

- [ ] 更新所有API调用，检查`result.code`而不是直接使用返回数据
- [ ] 从`result.data`中获取业务数据
- [ ] 更新错误处理逻辑，使用`result.msg`显示错误信息
- [ ] 更新分页数据处理，使用`data.page_info`结构
- [ ] 更新TypeScript类型定义（如果使用）
- [ ] 更新单元测试中的mock数据格式
- [ ] 更新文档和注释
- [ ] 测试所有相关功能

## 🧪 测试建议

1. **单元测试更新**: 更新mock数据为新的三范式格式
2. **集成测试**: 测试完整的请求-响应流程
3. **错误场景测试**: 测试各种错误码的处理
4. **边界测试**: 测试空数据、分页边界等情况

## 📞 支持和反馈

如在适配过程中遇到问题，请：
1. 查看本文档的常见问题部分
2. 联系后端开发团队确认接口行为
3. 在团队群中反馈问题

---
**适配指南版本**: v1.0  
**更新时间**: 2024年1月  
**适用范围**: 三范式响应格式改造