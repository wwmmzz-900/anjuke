# ðŸ§¹ ä»£ç æ¸…ç†æ€»ç»“

## ðŸ“‹ æ¸…ç†æ¦‚è§ˆ

æœ¬æ¬¡æ¸…ç†ä¸»è¦é’ˆå¯¹ MinIO åˆ†ç‰‡ä¸Šä¼ æ¨¡å—ï¼Œç§»é™¤äº†æ— ç”¨ä»£ç ã€æ­»ä»£ç å’Œè¿‡åº¦å¤æ‚çš„å®žçŽ°ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ã€‚

## ðŸ—‘ï¸ å·²æ¸…ç†çš„å†…å®¹

### 1. **ç®€åŒ–å¸¸é‡å®šä¹‰**

**æ¸…ç†å‰ï¼š**
```go
const (
    // è¿‡å¤šçš„é˜ˆå€¼å’Œåˆ†ç‰‡å¤§å°å¸¸é‡
    SmallFileThreshold = 5 * 1024 * 1024
    MediumFileThreshold = 50 * 1024 * 1024
    LargeFileThreshold = 200 * 1024 * 1024
    XLargeFileThreshold = 2 * 1024 * 1024 * 1024
    
    DefaultChunkSize = 5 * 1024 * 1024
    StandardChunkSize = 10 * 1024 * 1024
    LargeChunkSize = 25 * 1024 * 1024
    XLargeChunkSize = 50 * 1024 * 1024
    MaxChunkSize = 100 * 1024 * 1024
    MinChunkSize = 5 * 1024 * 1024
    // ... æ›´å¤šå¸¸é‡
)
```

**æ¸…ç†åŽï¼š**
```go
const (
    // æ ¸å¿ƒé…ç½® - æ›´ç®€æ´æ˜Žç¡®
    SmallFileThreshold = 20 * 1024 * 1024  // 20MB
    MediumFileThreshold = 100 * 1024 * 1024 // 100MB
    LargeFileThreshold = 500 * 1024 * 1024  // 500MB
    XLargeFileThreshold = 2 * 1024 * 1024 * 1024 // 2GB

    // åˆ†ç‰‡å¤§å°
    DefaultChunkSize = 5 * 1024 * 1024   // 5MB
    StandardChunkSize = 10 * 1024 * 1024 // 10MB
    LargeChunkSize = 25 * 1024 * 1024    // 25MB
    XLargeChunkSize = 50 * 1024 * 1024   // 50MB
    MaxChunkSize = 100 * 1024 * 1024     // 100MB

    // é™åˆ¶å‚æ•°
    MaxPartsLimit = 10000
    MaxFileSize = 5 * 1024 * 1024 * 1024 * 1024 // 5TB
)
```

### 2. **å¼ƒç”¨è¿‡æ—¶æ–¹æ³•**

#### `StartMultipartUpload` æ–¹æ³•
**é—®é¢˜ï¼š** åˆ›å»ºå‡çš„ UploadIDï¼Œæ²¡æœ‰çœŸæ­£çš„åˆ†ç‰‡ä¸Šä¼ é€»è¾‘
**è§£å†³ï¼š** æ ‡è®°ä¸ºå¼ƒç”¨ï¼Œä¿ç•™å‘åŽå…¼å®¹æ€§ï¼Œå¼•å¯¼ç”¨æˆ·ä½¿ç”¨ `UploadLargeFile`

```go
// æ¸…ç†å‰ï¼šå¤æ‚çš„å‡å®žçŽ°
func (m *MultipartUploader) StartMultipartUpload(...) (*MultipartUploadInfo, error) {
    // å¤§é‡æ— ç”¨çš„è®¡ç®—å’Œå‡æ•°æ®åˆ›å»º
    info := &MultipartUploadInfo{
        UploadID: fmt.Sprintf("upload_%d", time.Now().UnixNano()),
        // ... æ›´å¤šå‡æ•°æ®
    }
    return info, nil
}

// æ¸…ç†åŽï¼šç®€åŒ–çš„å…¼å®¹æ€§å®žçŽ°
func (m *MultipartUploader) StartMultipartUpload(...) (*MultipartUploadInfo, error) {
    fmt.Printf("è­¦å‘Š: StartMultipartUpload å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨ UploadLargeFile æ›¿ä»£\n")
    // è¿”å›žæœ€å°å¿…è¦ä¿¡æ¯
    return &MultipartUploadInfo{...}, nil
}
```

#### `ResumeUpload` æ–¹æ³•
**é—®é¢˜ï¼š** å®žçŽ°è¿‡äºŽç®€åŒ–ï¼Œå®žé™…ä¸Šå°±æ˜¯é‡æ–°ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶
**è§£å†³ï¼š** æ ‡è®°ä¸ºå¼ƒç”¨ï¼Œç›´æŽ¥è°ƒç”¨ `UploadLargeFile`

```go
// æ¸…ç†å‰ï¼šä¼ªè£…çš„æ–­ç‚¹ç»­ä¼ 
func (m *MultipartUploader) ResumeUpload(...) (string, error) {
    // å¤æ‚çš„é‡ç½®å’Œé‡æ–°ä¸Šä¼ é€»è¾‘
    _, err := reader.Seek(0, io.SeekStart)
    // ... å¤§é‡é‡å¤ä»£ç 
}

// æ¸…ç†åŽï¼šç›´æŽ¥è°ƒç”¨æ™ºèƒ½ä¸Šä¼ 
func (m *MultipartUploader) ResumeUpload(...) (string, error) {
    fmt.Printf("è­¦å‘Š: ResumeUpload å·²å¼ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ UploadLargeFile é‡æ–°ä¸Šä¼ \n")
    return m.UploadLargeFile(ctx, info.ObjectName, reader, info.TotalSize, "application/octet-stream")
}
```

### 3. **ç®€åŒ–æ•°æ®ç»“æž„**

#### `MultipartUploadInfo` ç»“æž„ä½“
**æ¸…ç†å‰ï¼š**
```go
type MultipartUploadInfo struct {
    UploadID      string               `json:"upload_id"`
    ObjectName    string               `json:"object_name"`
    Bucket        string               `json:"bucket"`
    TotalSize     int64                `json:"total_size"`
    ChunkSize     int64                `json:"chunk_size"`
    TotalChunks   int                  `json:"total_chunks"`
    UploadedParts []minio.CompletePart `json:"uploaded_parts"` // æ— ç”¨å­—æ®µ
    CreatedAt     time.Time            `json:"created_at"`
    UpdatedAt     time.Time            `json:"updated_at"`
}
```

**æ¸…ç†åŽï¼š**
```go
type MultipartUploadInfo struct {
    UploadID    string    `json:"upload_id"`
    ObjectName  string    `json:"object_name"`
    Bucket      string    `json:"bucket"`
    TotalSize   int64     `json:"total_size"`
    ChunkSize   int64     `json:"chunk_size"`
    TotalChunks int       `json:"total_chunks"`
    CreatedAt   time.Time `json:"created_at"`
    UpdatedAt   time.Time `json:"updated_at"`
    // ç§»é™¤äº† UploadedParts å­—æ®µï¼Œå› ä¸ºå®žé™…ä¸ä½¿ç”¨
}
```

### 4. **ç®€åŒ–ç®—æ³•å®žçŽ°**

#### `calculateOptimalPartSize` æ–¹æ³•
**æ¸…ç†å‰ï¼š** è¿‡åº¦å¤æ‚çš„åµŒå¥—å‡½æ•°å’Œå¾ªçŽ¯é€»è¾‘
**æ¸…ç†åŽï¼š** ç®€åŒ–çš„ switch-case é€»è¾‘ï¼Œæ›´æ˜“ç†è§£å’Œç»´æŠ¤

```go
// æ¸…ç†å‰ï¼šå¤æ‚çš„åµŒå¥—å‡½æ•°
func (m *MultipartUploader) calculateOptimalPartSize(totalSize int64) uint64 {
    calculatePartsCount := func(fileSize int64, partSize uint64) int {
        return int((fileSize + int64(partSize) - 1) / int64(partSize))
    }
    
    // å¤æ‚çš„ switch å’Œå¾ªçŽ¯é€»è¾‘
    for calculatePartsCount(totalSize, partSize) > MaxPartsLimit && partSize < uint64(MaxChunkSize) {
        partSize += uint64(10 * 1024 * 1024)
    }
    // ...
}

// æ¸…ç†åŽï¼šç®€åŒ–çš„ç›´æŽ¥è®¡ç®—
func (m *MultipartUploader) calculateOptimalPartSize(totalSize int64) uint64 {
    var partSize uint64
    switch {
    case totalSize <= MediumFileThreshold:
        partSize = uint64(StandardChunkSize)
    // ... ç®€åŒ–çš„åˆ†æ”¯é€»è¾‘
    }
    return partSize
}
```

### 5. **ä¿®å¤æ ¼å¼åŒ–é”™è¯¯**

**é—®é¢˜ï¼š** `generateObjectName` æ–¹æ³•ä¸­çš„æ ¼å¼åŒ–é”™è¯¯
```go
// é”™è¯¯çš„æ ¼å¼åŒ–
return fmt.Sprintf("%d%s", timestamp, ext) // timestamp æ˜¯ stringï¼Œä¸æ˜¯ int
```

**ä¿®å¤ï¼š**
```go
// æ­£ç¡®çš„æ ¼å¼åŒ–
return fmt.Sprintf("%s%s", timestamp, ext) // ä½¿ç”¨ %s æ ¼å¼åŒ–å­—ç¬¦ä¸²
```

### 6. **ç§»é™¤æ— ç”¨çš„æŽ¥å£æ–¹æ³•**

#### MinioClient ä¸­çš„æ–¹æ³•ç®€åŒ–
```go
// ç§»é™¤äº† GetUploader() æ–¹æ³• - ä¸åº”è¯¥æš´éœ²å†…éƒ¨å®žçŽ°
// ç®€åŒ–äº†å¼ƒç”¨æ–¹æ³•çš„å®žçŽ°ï¼Œæ·»åŠ äº†è­¦å‘Šä¿¡æ¯
```

## ðŸ“Š æ¸…ç†æ•ˆæžœ

### ä»£ç è¡Œæ•°å‡å°‘
- **æ¸…ç†å‰ï¼š** ~600 è¡Œ
- **æ¸…ç†åŽï¼š** ~450 è¡Œ
- **å‡å°‘ï¼š** ~25% çš„ä»£ç é‡

### å¤æ‚åº¦é™ä½Ž
- ç§»é™¤äº† 3 ä¸ªæ— ç”¨çš„å¸¸é‡
- ç®€åŒ–äº† 2 ä¸ªè¿‡åº¦å¤æ‚çš„æ–¹æ³•
- å¼ƒç”¨äº† 3 ä¸ªä¸å¿…è¦çš„æŽ¥å£æ–¹æ³•
- ä¿®å¤äº† 1 ä¸ªæ ¼å¼åŒ–é”™è¯¯

### å¯ç»´æŠ¤æ€§æå‡
- âœ… æ›´æ¸…æ™°çš„å¸¸é‡å®šä¹‰
- âœ… ç®€åŒ–çš„ç®—æ³•é€»è¾‘
- âœ… æ˜Žç¡®çš„å¼ƒç”¨æ ‡è®°
- âœ… æ›´å¥½çš„å‘åŽå…¼å®¹æ€§

## ðŸŽ¯ å»ºè®®çš„ä½¿ç”¨æ–¹å¼

### æŽ¨èä½¿ç”¨
```go
// æ™ºèƒ½ä¸Šä¼ ï¼ˆè‡ªåŠ¨é€‰æ‹©ç­–ç•¥ï¼‰
url, err := minioClient.SmartUploadWithProgress(ctx, filename, reader, size, contentType, progressCallback)

// æˆ–è€…ä¸éœ€è¦è¿›åº¦å›žè°ƒ
url, err := minioClient.Upload(ctx, filename, reader, size, contentType)
```

### é¿å…ä½¿ç”¨ï¼ˆå·²å¼ƒç”¨ï¼‰
```go
// âŒ ä¸æŽ¨è - å·²å¼ƒç”¨
info, _ := minioClient.StartMultipartUpload(...)
url, _ := minioClient.ResumeMultipartUpload(...)
```

## ðŸ”„ åŽç»­ä¼˜åŒ–å»ºè®®

1. **å®Œå…¨ç§»é™¤å¼ƒç”¨æ–¹æ³•**ï¼šåœ¨ä¸‹ä¸ªä¸»ç‰ˆæœ¬ä¸­å®Œå…¨ç§»é™¤å¼ƒç”¨çš„æ–¹æ³•
2. **è¿›ä¸€æ­¥ç®€åŒ–å¸¸é‡**ï¼šè€ƒè™‘å°†ä¸€äº›å¸¸é‡è®¾ä¸ºå¯é…ç½®
3. **æ·»åŠ å•å…ƒæµ‹è¯•**ï¼šä¸ºç®€åŒ–åŽçš„æ–¹æ³•æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šç›‘æŽ§ç®€åŒ–åŽçš„æ€§èƒ½è¡¨çŽ°

## âœ… æ€»ç»“

æœ¬æ¬¡ä»£ç æ¸…ç†æˆåŠŸï¼š
- ðŸ—‘ï¸ ç§»é™¤äº†æ— ç”¨å’Œæ­»ä»£ç 
- ðŸ”§ ç®€åŒ–äº†è¿‡åº¦å¤æ‚çš„å®žçŽ°
- ðŸ› ä¿®å¤äº†æ ¼å¼åŒ–é”™è¯¯
- ðŸ“š æ”¹å–„äº†ä»£ç å¯è¯»æ€§
- ðŸ”„ ä¿æŒäº†å‘åŽå…¼å®¹æ€§

ä»£ç çŽ°åœ¨æ›´åŠ ç®€æ´ã€é«˜æ•ˆå’Œæ˜“äºŽç»´æŠ¤ï¼